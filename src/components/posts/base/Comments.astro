<div id="waline"></div>

<link
  rel="stylesheet"
  href="https://unpkg.com/@waline/client@v3/dist/waline.css"
/>

<style is:global>
  /* 去掉 Waline 所有圆角 */
  #waline .wl-editor,
  #waline .wl-input,
  #waline span.wl-badge,
  #waline .wl-btn,
  #waline .wl-comment,
  #waline .wl-card,
  #waline .wl-panel,
  #waline .wl-header,
  #waline .wl-gif-popup,
  #waline .wl-emoji-popup,
  #waline .wl-footer {
    border-radius: 0 !important;
    font-family: 'ShangguSansSC Variable', system-ui, -apple-system, sans-serif !important;
  }

  .wl-content,
  .wl-content * {
    white-space: normal !important;
    word-break: break-word !important;
    overflow-wrap: anywhere !important;
  }

  /* 浅色模式下的颜色设置 */
  #waline {
    --waline-theme-color: #000000 !important;
    --waline-active-color: #dc2626 !important;
    /* 设置字体 */
    --waline-font-size: 1rem !important;
    --waline-font-family: 'Onest Variable', 'Geist Variable', 'ShangguSansSC Variable', system-ui, -apple-system, sans-serif !important;
  }

  /* 深色模式下的颜色和背景设置 */
  html.dark #waline {
    --waline-theme-color: #ffffff !important;
    --waline-active-color: #dc2626 !important;
  }

  html.dark #waline .wl-panel {
    --waline-bgcolor: #101018 !important;
    background-color: #101018 !important;
  }

  /* 禁用输入框获得焦点时的样式变化 */
  #waline .wl-editor:focus,
  #waline .wl-editor:focus-within,
  #waline .wl-input:focus {
    background-color: var(--waline-bgcolor) !important;
    box-shadow: none !important;
    outline: none !important;
  }
</style>

<script src="https://unpkg.com/@waline/client@v3/dist/waline.umd.js" defer></script>
<script>
function loadWaline() {
  const container = document.querySelector('#waline');
  if (!container) return; // 容器不存在就不初始化

  const w = (window as any).Waline;
  if (!w) return;

  // 如果已有实例，先安全销毁
  const oldInstance = (window as any).__walineInstance;
  if (oldInstance && typeof oldInstance.destroy === 'function') {
    try {
      // 只有当挂载点还在 DOM 中时才销毁
      if (container.contains(container.firstChild) || container.childNodes.length > 0) {
        oldInstance.destroy();
      }
    } catch (e) {
      console.warn('Waline destroy failed:', e);
    }
  }

  // 重新初始化并保存实例
  (window as any).__walineInstance = w.init({
    el: container,
    serverURL: 'https://waline.refact.cc/',
    path: location.pathname.replace(/\/$/, ''),
    lang: 'zh-CN',
    pageview: true,
    dark: 'html.dark',
    requiredMeta: ['nick', 'mail'],
    locale: { placeholder: '写点什么吧…' }
  });
}


  // 首次加载
  window.addEventListener('DOMContentLoaded', loadWaline);

  // PJAX 完成后
  document.addEventListener('pjax:complete', loadWaline);

  // Astro View Transitions 完成后
  document.addEventListener('astro:page-load', loadWaline);
</script>
